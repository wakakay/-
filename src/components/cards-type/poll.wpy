<style lang="less" scoped>

</style>

<template>
    <scroll-view class="module-poll-box" :class="{'is-phonex': isIphonex}"
                 scroll-y
                 scroll-top="{{scrollTop}}"
                 scroll-with-animation="{{isScrollAnimation}}">
        <view class="ui-content">
            <view class="ui-thumb" wx:if="{{cardsList[cardIndex].bigimage}}">
                <image mode="aspectFit" src="{{cardsList[cardIndex].bigimage}}"></image>
            </view>
            <view class="ui-title">{{cardsList[cardIndex].title}}</view>

            <view class="ui-answer-list">
                <repeat for="{{cardsList[cardIndex].select}}" key="index" index="index" item="item">
                    <view class="ui-item"
                          hover-class="{{!isAnswerOver && !cardsList[cardIndex].allowToNext ? 'ui-item-hover' : ''}}"
                          :class="{'is-selected': item.selected, 'is-selected-over': (isAnswerOver || cardsList[cardIndex].isDone) && item.selected}"
                          data-item="{{ item }}"
                          data-index="{{ index }}"
                          @tap.stop="getSelected">
                        <view class="ui-prop"
                              style="width: {{ballotInfo[item.id] || item.prop}}%"></view>
                        <view class="cell-title cross-center">
                            <text>{{item.option}}</text>
                            <view class="cell-pointer" wx:if="{{!(cardsList[cardIndex].isDone)}}"></view>
                            <view class="cell-number" wx:if="{{cardsList[cardIndex].isDone}}">{{ballotInfo[item.id] || item.prop || 0}}%</view>
                        </view>
                    </view>
                </repeat>
            </view>
        </view>
    </scroll-view>
</template>

<script>
    import wepy from 'wepy'
    import {getStore, connect} from 'wepy-redux'
    import {parsePercentageForPoll} from '../../utils'
    import _ from 'underscore'

    const store = getStore()
    @connect({
        systemInfo(state) {
            return state.user
        }
    })
    export default class pollCard extends wepy.component {
        props = {
            cardIndex: {
                type: Number
            },

            cardsList: {
                type: Array,
                default: []
            }
        }

        data = {
            isIphonex: /iphone10|iphone x/i.test(wx.getSystemInfoSync().model),
            isScrollAnimation: false, // 滚动条是否要动画
            scrollTop: 0, // 滚动条的位置
            oldIndex: -1, // 记录之前的卡片索引
            selectedId: '', // 选中的顺序
            selectedInfo: {}, // 当前选中的那个选项
            ballotInfo: {}, // 投票比例
            ballotTotal: 0, // 全部票数
            resultId: -1, // 正确的结果id
            isAnswerOver: false, // 是否作答结束
            description: '', // 选中的答案的解释详情
        }

        onLoad() {
            let self = this
        }

        methods = {
            /**
             * 选中某个选项
             * @param event
             * @returns {boolean}
             */
            getSelected(event) {
                let self = this
                let cardItem = self.cardsList[self.cardIndex]
                // poll只能投一次
                if (cardItem.isDone
                    || (self.isAnswerOver && self.oldIndex === self.cardIndex)) {
                    return false
                }

                let {currentTarget: {dataset: {item, index}}} = event
                let selectList = cardItem.select
                let selectedIds = []
                if ('single' === cardItem.cardStatus) {
                    _.each(selectList, (data) => {
                        data.selected = item.id === data.id ? true : false
                    })
                } else {
                    selectList[index].selected = !selectList[index].selected
                }

                 _.each(selectList, (data) => {
                    if (data.selected) {
                        return selectedIds.push(data.id)
                    }
                })

                let data = {
                    isFinish: selectedIds.length ? true : false,
                    id: cardItem.id,
                    selectedId: item.id,
                    selectedItem: {id: selectedIds.join(',')},
                    select: selectList,
                    fullImageBottomtText: selectedIds.length ? '我选好了' : '请投票'
                }

                self.$emit('on-interaction', data)
            }
        }

        events = {
            /**
             * 监听父级页面触发提交答案
             * @param data
             */
            'broadcast-poll': (data) => {
                let self = this
                let cardItem = self.cardsList[self.cardIndex].select
                let item = _.find(cardItem, {id: data.selectedId})
                self.resultId = item.id
                // 统计全部投票人数
                let selectList = cardItem.select
                let ballotTotal = _.reduce(cardItem, (memo, data) => {
                    data.add = data.selected ? 1 : 0
                    return memo + data.ballot + data.add
                }, 0)

                // 计算每个投票的比例
                _.each(cardItem, (data) => {
                    let add = data.id === item.id ? 1 : 0
                    self.ballotInfo[data.id] = Math.floor((data.ballot + data.add) / ballotTotal * 1000) / 10
                })

                self.isAnswerOver = true
                self.oldIndex = _.clone(self.cardIndex)
                if (self.isExercises) {
                    self.scrollTop = 500
                    self.isScrollAnimation = true
                    setTimeout(()=>{
                        self.isScrollAnimation = false
                        self.$apply()
                    }, 300)
                }
                self.$apply()
            },
            /**
             * 监听父级，重置初始化数据
             * @param data
             */
            'broadcast-reset-status': (data) => {
                let self = this
                self.scrollTop = 0
                self.oldIndex = -1 // 记录之前的卡片索引
                self.selectedId = 0 // 当前选中的那个选项
                self.resultId = -1 // 正确的结果id
                self.isAnswerOver = false // 是否作答结束
                self.$apply()
            }
        }
    }
</script>
